@model Model.FlowerArrangement
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>花卉详情</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link href="~/layui/css/layui.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="~/FileCss/css/m2015.css?version=847" />
    <link href="~/uploadify/webuploader.css" rel="stylesheet" />
    <link href="~/FileCss/css/Arrangement.css?v=1" rel="stylesheet" />
    <style>
        <!-- -->
        .spanstyle {
            font-weight: 600;
            float: left;
        }
        .week {
            display: inline-block;
            width: 27%;
            height: 26px;
            text-align: center;
            line-height: 24px;
            color: #fff;
            background: #a0c716;
            margin: 7px 10px;
            border-radius: 16px;
        }
        .left {
            display: inline-block;
            width: 27%;
            height: 26px;
            text-align: center;
            line-height: 24px;
            color: #fff;
            background: #a0c716;
            margin: 7px 10px;
            border-radius: 5px;
        }
        .put {
            float: right;
            background-color: #a0c716;
            width: 32%;
            border-radius: 20px;
            text-align: center;
            height: 35px;
            line-height: 33px;
            border: none;
            margin-right: 3px;
            margin-top: 40px;
            color: #fff;
        }
        .upload {
            float: left;
            background-color: #ff6a00;
            width: 32%;
            border-radius: 20px;
            height: 33px;
            line-height: 33px;
            border: none;
            color: #fff;
        }
        .leftpadding {
            margin-top: 20px;
        }
        .changec {
            color: #f44623;
        }
        .btn-delete {
            position: absolute;
            color: red;
            margin-top:-5px;
            cursor:pointer;
        }
        .upload-item img{
            border-radius: 6px;
        }
        .uploader-list {
            width: 35%;
            float: left;
        }
    </style>

    <style>
        ul, li {
            margin: 0;
            padding: 0;
        }

        div.imgbox {
            width: 100%;
            height: 36px;
            overflow: hidden;
            margin: 0 auto;
        }

        div.imgbox ul {
            clear: both;
            width: 75rem;
            display: inline-block;
         }  
         div.imgbox ul li {
             float: left;
              width: 25rem;
              height: 16.5rem;
              overflow: hidden;
              text-align: center;
          }
         div.imgbox ul li img {
              width: 100%;
              height: 36px;
          }
    </style>
</head>
<body>    
    <header id="header" style="background:#ffffff">
        <div class="topbar">
            <a href="javascript:history.back();" class="back_btn"><i class="iconfont">ş</i></a>
            <a href="javascript:;" class="top_home"><i class="iconfont">ƙ</i></a>
            <h1 class="page_title">花卉详情</h1>
        </div>
        <div class="home_menu" id="hMenu">
            @*<a href="/Shop/Index"><i class="iconfont">Ő</i><span>我要买花</span></a>
        <a href="/MFlower/ConservationFlowers"><i class="iconfont">Ɔ</i><span>养护花卉</span></a>
        <a href="/MFlower/ChangeFlowers"><i class="iconfont">ŭ</i><span>更换花卉</span></a>
        <a href="/MMIndex/Index"><i class="iconfont">Œ</i><span>会员中心</span></a>*@
            <a href="/MLogin/Index?ArrangementId=@Model.id"><i class="iconfont">Œ</i><span>切换帐号</span></a>
            @if (ViewData["IsAllower"].ToString() != "1")
            {
            <a href="/MFlower/TreatRecord?ArrangementId=@Model.id"><i class="iconfont">ŭ</i><span>反馈记录</span></a>
            }
            else
            {
             <a href="/MFlower/TreatRecord?ArrangementId=@Model.id"><i class="iconfont">ŭ</i><span>养护记录</span></a>
            }
        </div>
    </header>     
        <div class="product" style="position:relative;">
            <div id="bigImg">
                <div id="pro_img" class="pro_img">
                    <div class="pro_img_box">
                        <ul>
                            <li>
                                <div class="pro_img_wrap">
                                    <img src="@Model.Photo" />
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="pro_img_nav">
                        @*<i class="iconfont pro_img_item cur">Ƴ</i>
              <i class="iconfont pro_img_item">Ƴ</i>
            System.Web.HttpUtility.UrlEncode(Model.OwnedCompany, System.Text.Encoding.UTF8)*@
                    </div>
                    <div class="appraise" style="float:right;">
                        <a href="javascript:void(0)"><span class="iconfontdi icon-dianzan">0</span></a>
                        <a href="javascript:void(0)"> <span class="iconfontca icon-dianzan_active">0</span></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="pro_tit border_bottom" style="min-height: 60px;">
            <h2 class="spanstyle">名称: @Model.FlowerWatchName </h2>
            @if (ViewData["IsAllower"].ToString() != "1")
            {
                @*<div class="week left">每周<span id="kly">@Model.Weekly</span>养护 </div>
                <a class="hehu"><div class="week left">需要呵护</div></a>*@
                 if(ViewBag.Treattime!=null)
                 {
                    <div class="left">正在养护中……</div>
                 }
            }
            else
            {
            @*<a href="/MFlower/ConservationFlowers?ownedcompany=@Model.OwnedCompany"><div class="week left">养护</div></a>*@  
              <a href="javascript:void(0)"><div class="endyh week" style="background-color:#ff6a00;display:none;">结束养护</div></a>            
              <a href="javascript:void(0)"><div class="ksyh week">开始养护</div></a>
            }
            @* <div style="padding-top:12px;padding-left: 72%;">
           <img width="20" height="20" src="~/static/image/1160675719.jpg" />
        规格: <span style="color:#f44623">@Model.Specifications </span>cm
          </div>
            <p>
            </p>*@
            
        </div>
        
        <div class="jb_canshu">            
            <ul>
                @if (!string.IsNullOrEmpty(Model.OwnedCompany))
                {
                    <li>【单位】@Model.OwnedCompany </li>
                }
                 @if (!string.IsNullOrEmpty(Model.arrangement))
                {
                    <li>【位置】@Model.arrangement </li>
                }
                @if (!string.IsNullOrEmpty(Model.XiXin))
                {
                    <li>【习性】@Model.XiXin</li>
                }
                @if (ViewData["IsAllower"].ToString() == "1")
                {
                     if (!string.IsNullOrEmpty(Model.Weekly))
                     {
                     <li>&nbsp;每周<span id="kly">@Model.Weekly</span>养护 </li>
                     }
                }
                @if (!string.IsNullOrEmpty(Model.YangHuFangFa))
                {
                    <li><span class="spanstyle">&nbsp;养护方法：</span><span id="fangfa">@Model.YangHuFangFa</span></li>
                }                
                <li style="color:#ff6a00;display:none;"><span class="spanstyle">&nbsp;温馨提示：</span><span id="tisi"></span></li>
                 
                @if(ViewBag.Treattime!=null)
                {
                   <li>
                     <span class="spanstyle">&nbsp;养护时间：</span>@ViewBag.Treattime.ToString("yyyy-MM-dd HH:mm:ss")
                  </li>
                }
                 @if(ViewBag.Treattime!=null)
                {
                <li>
                    <span class="spanstyle">&nbsp;预计下次养护时间：</span>@ViewBag.PlanTreatTime.ToString("yyyy-MM-dd HH:mm:ss")
                </li>  
                }
            </ul>            
        </div>     
    
        <div class="jb_canshu">
        @if (ViewData["IsTourist"] == null)
        {
            if (ViewData["IsAllower"].ToString() == "1")
            {
            <div>
                <span style="font-size:15px;font-weight:600"></span>
            </div>
            @*<div class="layui-upload" style="text-align:center;">
            <button type="button" class="layui-btn upload" id="test8">+上传图片</button>
            <input type="button" id="test9" class="put"  value="提交花卉" />
        ```</div>*@ <!--dom结构部分-->
            <div id="serveraf" style="padding-top:10px">
                <table style="width:100%">
                    <thead>
                        <tr><th>服务前</th><th>服务后</th><th></th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <span class="list">
                                    <img src="" class="imgphoto" id="bphoto" width="80" height="80" />
                                </span>
                            </td>
                            <td>
                                <span class="list">
                                    <img id="cphoto" src="~/FileCss/images/nopic.png" width="80" height="80" />
                                </span>
                            </td>
                            <td>
                                <span class="gh">
                                    <em id="contentmsg">
                                    </em>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="serverbefor" style="padding-top:10px;height:200px;">
                <textarea id="remarks" maxlength="12" style="margin: 0px auto;text-align:left; height: 105px; width: 98%;
            border:0px solid #e6dddd; border-collapse:collapse; " placeholder="可填写：植物缺水枯萎、环境冷需撤离等"></textarea>
                <div id="uploader-demo" style="">
                    <!--用来存放item-->
                    <div style="height:2px;"><img src="" /></div>
                    <div id="fileList" class="uploader-list"></div>
                    <div id="filePicker" style="width:28.4%; float: left;">
                        <span class="icon iconfontzp icon-icon-zhaopian-shangchuan"></span>
                    </div>
                    <input type="button" id="test9" class="put" value="提交" />

                </div>
            </div>

            }
            else  //客户
            {
        <div id="xyhh" style="padding-top:10px;height:200px;">
            <textarea id="remarks" maxlength="12" style="margin: 0px auto;text-align:left; height: 105px; width: 98%;
                border:0px solid #e6dddd; border-collapse:collapse; " placeholder="可填写：植物缺水枯萎、环境冷需撤离等"></textarea>
            <div id="uploader-demo" style="">
                <!--用来存放item-->
                <div id="fileList" class="uploader-list"></div>
                <div id="filePicker" style="width:28.4%; float: left;">
                    <span class="icon iconfontzp icon-icon-zhaopian-shangchuan"></span>
                </div>
                <input type="button" id="test9" class="put" value="提交" />

            </div>
        </div>
            }
         }
       <input type="hidden" id="FlowerArrangementId" value="@Model.id" />
        </div>    
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/uploadify/webuploader.html5only.min.js"></script>
    <script src="~/FileCss/jq/silder-h5.js"></script>
    @Scripts.Render("~/Thems/js/layer/layer.js")
    <script>
        //
        $(function () {
            $(".top_home").click(function () {
                var target = $(".home_menu");
                if (target.slideToggle) target.slideToggle();
                else target.toggle();
            });
            //图片正方形
            var width = $(".pro_img_box li img").width();
            $(".pro_img_box li img").height(width);
            $(".product").height(width);//2019-1105第一栏白色区域高度
            //数字变颜色
            var fangfa = $("#fangfa").html();
            if (fangfa != undefined) {
                var reg = /\d+/g;
                var ms = fangfa.match(reg);
            }
            if (ms != undefined) {
                for (var i = 0; i < ms.length; i++) {
                    fangfa = fangfa.replace(ms[i], "<span class='changec'>" + ms[i] + "</span>");
                }
                $("#fangfa").html(fangfa);
            }
            //数字转换星期
            var oldv = $("#kly").text().trim();
            var show_day = new Array('一', '二', '三', '四', '五', '六', '日');
            $("#kly").text(show_day[oldv - 1]);
            //加载广告
            //onloadAdvlist();

            //开始养护
            $(".ksyh").on('click',ksyh);
            function ksyh()
            {
                $this = $(".ksyh");
                $this.unbind("click"); //移除click
                 $.ajax({
                     url: "/MFlower/StartCurFlowers?ownedUsersId=@Model.belongUsersId&arrid=@Model.id",
                     type: "get",
                     dataType: "json",
                     success: function (data, state) {
                         if (data == "1") {  
                             var i = 10;
                             //console.log('k', i);                           
                             //设置定时器
                             var btnTimer = null;
                             btnTimer= setInterval(function () {
                                 // 开始计数
                                 i--;
                                 // 注意clearInterval一定要最后，不然attr和text函数不会执行
                                 if (i <= 0) {
                                     $this.bind("click", ksyh); //click
                                     $(".ksyh").hide();
                                     $(".endyh").show();
                                     $(".endyh").text('结束养护');
                                     clearInterval(btnTimer);
                                 }
                                 else { $this.text(i); }
                             }, 1000);
                           
                         }
                         else if (data == "0") {
                             layer.open({
                                 content: "今日已提交" , btn: '我知道了'
                             });
                         }
                     },
                     error: function (m) { parent.layer.msg("error"); }
                 });
            }

            //结束养护
            $(".endyh").on("click",endyh);
            function endyh() {
                $this = $(".endyh");
                $this.unbind("click"); //移除click
                $.ajax({
                    url: "/MFlower/EndCurFlowers?ownedUsersId=@Model.belongUsersId&arrid=@Model.id",
                    type: "get",
                    dataType: "json",
                    success: function (data, state) {
                        if (data == "1") {
                            var i = 10;
                            //$this.unbind("click"); //移除click
                            //设置定时器
                            var btnTimer = null;
                            btnTimer = setInterval(function () {
                                // 开始计数
                                i--;
                                // 注意clearInterval一定要最后，不然attr和text函数不会执行
                                if (i <= 0) {
                                    $this.bind("click", endyh); //绑定自身的click
                                    $(".ksyh").show();
                                    $(".endyh").hide();
                                    $(".ksyh").text('开始养护');
                                    clearInterval(btnTimer);
                                }
                                else { $this.text(i); }
                            }, 1000);
                        }
                    },
                    error: function (m) { parent.layer.msg("error"); }
                });
            }
            @*//养护记录
            $(".top_home").click(function () {
                var isallower='@ViewData["IsAllower"].ToString()';
                if(isallower!= "1")
                {
                    window.location.href = '/FlowerTreatment/CusTreatRecord?flowernumber=@Model.ShopId'
                }
                else{
                    window.location.href = '/FlowerTreatment/TreatRecord?flowernumber=@Model.ShopId'
                }
            });*@
            //显示评价数量
            Appraisecount();
            //好评
            $(".iconfontdi").click(function () {
                $.ajax({
                    url: "/MFlower/SetFlowerGood?ArrangementId=@Model.id",
                    type: "get",
                    dataType: "json",
                    success: function (res, state) {
                        $(".iconfontdi").unbind('click');
                        if (res.data != "0") {
                            layer.msg('提交成功');                          
                            Appraisecount();
                        } else {
                            layer.msg('今日已评价');
                        }
                    },
                    error: function (m) { parent.layer.msg(m); }
                });
                
            });
            //差评
            $(".iconfontca").click(function () {
                parent.layer.open({
                    type: 2,
                    title: '提交意见',
                    shadeClose: true,
                    shade: 0.8,
                    area: ['300px;', '200px;'],
                    content: '/MFlower/SetFlowerBad?ArrangementId=@Model.id',
                    end: function (res) { //层彻底关闭后执行的回调     
                        console.log("rde", res);
                        Appraisecount();
                    }
                });
            });
            //加载服务前的图
            onloadServbefor();
            //加载温馨提示
            GetWarm();
        });
        $(function () {
            // 初始化Web Uploader
            var uploader = WebUploader.create({
                // 选完文件后，是否自动上传。
                auto: false,
                duplicate :true,//重复上传同一文件
                // swf文件路径
                //swf: BASE_URL + '/js/Uploader.swf',
                // 文件接收服务端。
                server: '/MFlower/Upload', //上传接口
                //server: '/Text/TextImg',
                // 选择文件的按钮。可选。
                // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                pick: '#filePicker',

                // 只允许选择图片文件。
                accept: {
                    title: 'Images',
                    extensions: 'gif,jpg,jpeg,bmp,png',
                    mimeTypes: 'image/*'
                }
            });
            //
            var $list = $("#fileList");
            uploader.on('uploadSuccess', function (file, response) {
                //$('#' + file.id).find('p.state').text('已上传');
                //$('#' + file.id).addClass('upload-state-done');
                if (response == "1") {
                    layer.msg('提交成功');
                    //客户
                    $("#remarks").val("");
                    $("#xyhh").html("植物问题已提交，请您耐心等待……");
                }
                else {
                    layer.msg('今日已提交');
                }
                uploader.reset();
                $list.html('');
            });

            uploader.on('uploadError', function (file) {
                $('#' + file.id).find('p.state').text('上传出错');
            });

            uploader.on('uploadComplete', function (file) {
                $('#' + file.id).find('.progress').fadeOut();
            });
            
            $list.on('click', '.upload-item .btn-delete', function () {
                // 从文件队列中删除某个文件id
                file_id = $(this).data('file_id');
                console.log('file_id', file_id);
                uploader.removeFile(file_id, true); // 从queue中删除
                var fileItem = $(this).parent();
                $(fileItem).fadeOut(function () {
                    $(fileItem).remove();
                });
                console.log(uploader.getFiles('cancelled'));//获得打上文件被移除标记的
            });
           
            // 当有文件添加进来的时候
            uploader.on('fileQueued', function (file) {
                var $li = $(
                        '<div id="' + file.id + '" class="upload-item">' +
                            '<img>' +
                            '<span data-file_id="' + file.id + '" class="btn-delete">x</span>' +
                        '</div>'
                        ),
                 $img = $li.find('img');


                // $list为容器jQuery实例
                $list.html($li);
                var thumbnailWidth = 75;
                var thumbnailHeight = 75;
                // 创建缩略图
                // 如果为非图片文件，可以不用调用此方法。
                // thumbnailWidth x thumbnailHeight 为 100 x 100
                uploader.makeThumb(file, function (error, src) {
                    if (error) {
                        $img.replaceWith('<span>不能预览</span>');
                        return;
                    }

                    $img.attr('src', src);
                }, thumbnailWidth, thumbnailHeight);
            });
            $btn = $(".put");
            //点击上传
            $btn.on('click', function () {
                var rem = $("#remarks").val();
                if (rem.length == 0) {
                    layer.msg('请填写这一刻的想法');
                    return;
                }
                if ($list.children('div').length > 0) {
                    $this = $(this);
                    // 保存原按钮的text值
                    var oldText = $this.val();
                    // 设置计时的开始值,5s要从6开始减
                    var i = 6;
                    //禁用按钮
                    $this.attr('disabled', true);
                    //设置定时器
                    var btnTimer = null;
                    btnTimer = setInterval(function () {
                        // 开始计数
                        i--;
                        // 注意clearInterval一定要最后，不然attr和text函数不会执行
                        if (i <= 0) {
                            $this.removeAttr('disabled');
                            $this.val(oldText);
                            clearInterval(btnTimer);
                        }
                        else { $this.val(i); }
                    }, 1000);
                    var obj = new Object();
                    obj.FlowerArrangementId = $("#FlowerArrangementId").val();
                    obj.remarks = $("#remarks").val();
                    uploader.options.formData = obj;
                    uploader.upload();
                    console.log("上传成功");
                }
                else { layer.msg('选择图片后上传'); }
            });

        });
    </script>
 <script>            
     function onloadAdvlist() {
         var html="";
         $.ajax({
             url: "/Adviertisement/GetAdvList",
             type: "get",
             dataType: "json",
             async:true,
             success: function (data, state) {
                 var companylist = data;
                 for (var i = 0; i < companylist.length; i++) {                      
                     html += ' <li><a href="' + companylist[i].Pictures + '"><img src="' + companylist[i].Picture + '" /></a></li>';
                 }
                 $(".imgbox ul").html(html);
                 var scrollImg = $.mggScrollImg('.imgbox ul', {
                     loop: true,//循环切换
                     auto: true,//自动切换
                     auto_wait_time: 3000,//轮播间隔
                     scroll_time: 300,//滚动时长
                     callback: function (ind) {//这里传过来的是索引值                   
                     }
                 });
             },
             rror: function (m) { parent.layer.msg("error"); }
         });
     }
     //统计评价数量
     function Appraisecount()
     {
         $.ajax({
             url: "/MFlower/GetAppraiseCount?ArrangementId=@Model.id",
             type: "get",
             dataType: "json",
             success: function (res, state) {
                 if (res.gcount != "0") {
                     $('.iconfontdi').text(res.gcount);
                 }
                 else if(res.bcount!=0){
                     $(".iconfontca").text(res.bcount);
                 }
             },
             error: function (m) { parent.layer.msg(m); }
         });
     }
     //加载温馨提示
     function GetWarm() {
         $.ajax({
             url: "/Adviertisement/GetWarmList?limit=1&offset=1",
             type: "get",
             dataType: "json",
             success: function (res, state) {
                 if (res.total != "0") {
                     $('#tisi').parent().show();
                     $('#tisi').text(res.rows[0].Content);
                 }
             },
             error: function (m) { parent.layer.msg(m); }
         });
     }
      //服务前图片
     function onloadServbefor()
     {
         if ('@ViewBag.Treattime'!='')
         {
             //管理员             
             $(".endyh").show();
             $(".ksyh").hide();
         }

         $.ajax({
             url: "/MFlower/ServerBefor?ownedUsersId=@Model.belongUsersId&arrid=@Model.id",
             type: "get",
             dataType: "json",
             success: function (res, state) {
                 if (res.data != "") {
                     $("#serveraf").show();
                     $("#bphoto").attr('src', res.data.Photo);
                     //$("#cphoto").attr('src', res.data.ChangePhoto);
                     $("#contentmsg").text(res.data.ContentMsg);
                     $("#serverbefor").hide();
                     //客户
                     $('.hehu div').text('正在维护中……');
                     $("#xyhh").html("植物问题已提交，请您耐心等待……");
                     //管理员增加服务后图片
                     $("#cphoto").click(function () {
                         var arrangementid=$("#FlowerArrangementId").val();
                         window.location.href = '/MFlower/AddServerPhoto?id='+res.data.id+'&ArrangementId='+arrangementid;
                     });
                 }
                 else 
                 {
                     $("#serverbefor").show();
                     $("#serveraf").hide();                    
                 }
             },
             error: function (m) { parent.layer.msg("error"); }
         });    
     }    
 </script>
</body>
</html>